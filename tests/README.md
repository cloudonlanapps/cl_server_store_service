# Tests for CL Server Store Service

This directory contains the test suite for the store microservice. The tests cover media management, job orchestration, authentication, permissions, and integration workflows using `pytest`.

## Overview & Structure

The test suite is organized into two categories:

- **Unit tests** (`test_*.py`) — Test individual components with in-memory SQLite databases and mocked dependencies
- **Integration tests** (`test_integration_*.py`) — Test end-to-end workflows with full service integration

## Prerequisites

- Python 3.12+
- [uv](https://github.com/astral-sh/uv) package manager
- Dependencies installed via `uv sync`

**Note:** With uv, you don't need to manually create or activate virtual environments. Use `uv run` to execute commands in the automatically managed environment.

## Service Requirements

Some tests require external tools and services:

### ExifTool & ffprobe

**Required** for metadata extraction tests (dimensions, duration, MIME types):

```bash
# macOS
brew install exiftool ffmpeg

# Linux (Debian/Ubuntu)
sudo apt-get install libimage-exiftool-perl ffmpeg

# Verify installation
exiftool -ver
ffprobe -version
```

### MQTT Broker (Optional)

Integration tests for MQTT functionality require a running MQTT broker. However, **most tests use mocked MQTT clients** and don't require a real broker.

**Starting MQTT Broker (Docker):**
```bash
docker run -d -p 1883:1883 eclipse-mosquitto
```

**Starting MQTT Broker (Local):**
```bash
# macOS
brew install mosquitto
brew services start mosquitto

# Linux (Debian/Ubuntu)
sudo apt-get install mosquitto
sudo systemctl start mosquitto

# Verify broker is running
mosquitto_sub -t test/topic &
mosquitto_pub -t test/topic -m "test"
```

### Test Media Files

Sample media files are automatically generated by fixtures in `conftest.py`. No manual setup required.

## Running Tests

### Run All Tests

To run the entire test suite with coverage:

```bash
uv run pytest
```

**Coverage requirement:** 90% (configured in `pyproject.toml`)

### Run Specific Test Files

To run tests from a specific file:

```bash
uv run pytest tests/test_entity_crud.py -v
uv run pytest tests/test_job_crud.py -v
uv run pytest tests/test_authentication.py -v
uv run pytest tests/test_plugin_image_resize.py -v
```

### Run Individual Tests

To run a specific test function:

```bash
uv run pytest tests/test_entity_crud.py::test_create_entity -v
uv run pytest tests/test_authentication.py::test_login_success -v
```

### Coverage Options

**Default behavior:** Coverage is automatically collected with HTML + terminal reports and requires ≥90% coverage.

```bash
# Run tests with coverage (generates htmlcov/ directory + terminal report)
uv run pytest

# Skip coverage for quick testing
uv run pytest --no-cov

# Override coverage threshold (e.g., for debugging)
uv run pytest --cov-fail-under=0
```

Coverage reports are saved to `htmlcov/index.html` - open this file in a browser to view detailed coverage.

## Test Organization

The test suite is organized into two main categories:

### Top-Level Tests

Tests in the root `tests/` directory:

| File | Description | Tests |
|------|-------------|-------|
| `conftest.py` | Shared pytest fixtures (sessions, clients, JWT tokens) | N/A |
| `test_cascade_deletion.py` | Cascade deletion verification for related entities | 4 |
| `test_config.py` | Configuration management and validation | 8 |
| `test_m_insight_mqtt.py` | MQTT integration for mInsight broadcasting | 12 |
| `test_m_insight_worker.py` | Worker reconciliation and entity processing | 18 |
| `test_media_files.py` | Media file handling and operations | 6 |
| `test_mqtt_broadcast.py` | MQTT broadcasting functionality | 10 |

### Integration Tests

Comprehensive integration tests in `test_store/test_integration/`:

| File | Description | Tests |
|------|-------------|-------|
| `test_entity_crud.py` | Entity CRUD operations (create, read, update, delete) | 22 |
| `test_authentication.py` | JWT authentication flows and token validation | 15 |
| `test_file_upload.py` | File upload, storage, and metadata extraction | 12 |
| `test_put_endpoint.py` | PUT endpoint validation and updates | 10 |
| `test_versioning.py` | SQLAlchemy-Continuum entity history tracking | 14 |
| `test_duplicate_detection.py` | MD5-based duplicate file detection | 8 |
| `test_pagination.py` | Pagination and page size validation | 18 |
| `test_user_tracking.py` | User identity tracking (added_by, updated_by) | 6 |
| `test_admin_endpoints.py` | Administrative operations and permissions | 8 |
| `test_runtime_config.py` | Runtime configuration updates | 5 |
| `test_health_check.py` | Health check endpoint validation | 3 |
| Plus 8 more integration test files | Various integration scenarios | 40+ |

**Total Tests:** 257 tests across 34 test files

### Test Characteristics

- **Database:** All tests use in-memory SQLite (`:memory:`) - no persistent state
- **Isolation:** Each test gets fresh database and test client
- **Fixtures:** Comprehensive fixtures for JWT tokens, test images, sessions
- **Markers:** `@pytest.mark.integration` for integration tests (though not consistently applied)
- **Async Tests:** Some tests use `@pytest.mark.asyncio` for async operations

## Plugin Testing

For detailed information on creating and testing compute plugins, see [../../docs/store-plugins-testing.md](../../docs/store-plugins-testing.md).

Quick reference:
- Use `test_plugin_template.py.template` as a starting point
- Follow the checklist in store-plugins-testing.md for comprehensive coverage
- Test both functional behavior and authentication/authorization

## Configuration

The test configuration is defined in `pyproject.toml` under `[tool.pytest.ini_options]`:
- **Test Paths**: `tests`
- **Coverage**: Automatically enabled with HTML + terminal reports
- **Coverage Threshold**: 90% minimum (tests fail if below)
- **Asyncio Mode**: Auto-detection for async tests

## Troubleshooting

### Async Test Warnings

**Issue:** `RuntimeWarning: coroutine was never awaited` warnings

**Cause:** Async tests missing `@pytest.mark.asyncio` decorator

**Solution:**
```python
# Add decorator to async tests
@pytest.mark.asyncio
async def test_something():
    await async_operation()
```

**Note:** This is a known issue affecting 8 tests in the suite. See [REVIEW.md](../REVIEW.md) issue CRITICAL-001.

---

### File Handle Leaks

**Issue:** `OSError: [Errno 24] Too many open files` error

**Cause:** Tests opening file handles without proper cleanup

**Solutions:**
1. **Use context managers:**
   ```python
   with open('file.txt', 'rb') as f:
       data = f.read()
   ```

2. **Increase file descriptor limit (temporary):**
   ```bash
   # macOS/Linux
   ulimit -n 4096
   ```

3. **Check for leaked handles:**
   ```bash
   # macOS/Linux
   lsof -p <pytest_pid> | grep REG
   ```

**Note:** This is a known issue in test_m_insight_worker.py. See [REVIEW.md](../REVIEW.md) issue HIGH-001.

---

### MQTT Connection Failures

**Issue:** `ConnectionRefusedError: [Errno 61] Connection refused` on port 1883

**Cause:** MQTT broker not running (or tests trying to connect to real broker)

**Solutions:**
1. **Most tests don't need real broker** - they use mocked MQTT clients
2. **For MQTT integration tests:**
   ```bash
   # Start broker
   docker run -d -p 1883:1883 eclipse-mosquitto

   # Or skip MQTT tests
   uv run pytest -m "not mqtt"  # If mqtt marker was used
   ```

3. **Check if broker is running:**
   ```bash
   lsof -i :1883
   ```

---

### Coverage Failures

**Issue:** `FAILED - Required test coverage of 90% not reached`

**Cause:** New code not covered by tests, or excluding too many files

**Solutions:**
1. **View detailed coverage report:**
   ```bash
   # Open HTML report
   open htmlcov/index.html

   # Or check terminal output
   uv run pytest  # Shows missing lines
   ```

2. **Override threshold for debugging:**
   ```bash
   uv run pytest --cov-fail-under=0
   ```

3. **Check excluded files in `pyproject.toml`:**
   ```toml
   [tool.coverage.run]
   omit = [
       "*/tests/*",
       "*/main.py",  # CLI entry points excluded
       "*/m_insight_worker.py",
   ]
   ```

---

### Database Lock Errors

**Issue:** `sqlite3.OperationalError: database is locked`

**Cause:** Multiple tests trying to access same database (shouldn't happen with in-memory DBs)

**Solutions:**
1. **Tests should use `:memory:` databases** - check fixtures
2. **Clear pytest cache:**
   ```bash
   rm -rf .pytest_cache
   rm -rf htmlcov
   ```

3. **Check for leaked database connections:**
   ```python
   # Fixtures should close sessions
   @pytest.fixture
   def test_db_session():
       session = create_session()
       yield session
       session.close()  # Important!
   ```

---

### Import Errors

**Issue:** `ModuleNotFoundError: No module named 'store'`

**Cause:** Python path not configured correctly

**Solutions:**
1. **Always use `uv run`:**
   ```bash
   uv run pytest  # Correct
   pytest         # Wrong - uses system pytest
   ```

2. **Check `pyproject.toml` pythonpath:**
   ```toml
   [tool.pytest.ini_options]
   pythonpath = ["src"]
   ```

---

### Flaky Tests

**Issue:** Tests pass sometimes, fail other times

**Cause:** Time-based synchronization using `time.sleep()`

**Affected Tests:**
- `test_m_insight_mqtt.py` - Uses `time.sleep()` for synchronization
- `test_mqtt_broadcast.py` - Similar timing issues

**Solutions:**
1. **Use proper sync primitives:**
   ```python
   # Instead of time.sleep()
   event = threading.Event()
   assert event.wait(timeout=5.0), "Operation timed out"
   ```

2. **Run tests multiple times to verify:**
   ```bash
   # Run 10 times to check for flakiness
   for i in {1..10}; do uv run pytest tests/test_specific.py || break; done
   ```

**Note:** This is a known issue. See [REVIEW.md](../REVIEW.md) issue MEDIUM-006.

---

### Test Image Files Not Found

**Issue:** Tests fail with `FileNotFoundError` for test images

**Cause:** Test fixtures generate images dynamically - may fail if PIL not working

**Solution:**
1. **Verify Pillow installed:**
   ```bash
   uv run python -c "from PIL import Image; print('OK')"
   ```

2. **Check conftest.py fixtures:**
   ```python
   @pytest.fixture
   def sample_image():
       # Should generate test image with PIL
       img = Image.new('RGB', (100, 100), color='red')
       ...
   ```

---

### For Additional Issues

See **[REVIEW.md](../REVIEW.md)** for comprehensive list of known issues, bugs, and fixes with detailed descriptions and GitHub issue templates.

## Quick Reference

For a quick command reference, see [QUICK.md](QUICK.md)
